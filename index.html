<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biometrick Pro v4.2</title>
    <!-- Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React y Babel para que funcione el código moderno -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useRef, useEffect } = React;

        // --- ICONOS (Simulados para no depender de librerías) ---
        const Icon = ({ name, className = "w-6 h-6" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, []);
            return <i data-lucide={name} className={className}></i>;
        };

        const DAYS_LIST = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];

        function App() {
            const [isUnlocked, setIsUnlocked] = useState(false);
            const [view, setView] = useState('login');
            const [activeTab, setActiveTab] = useState('home');
            const [currentEmployee, setCurrentEmployee] = useState(null);
            const [aiMessage, setAiMessage] = useState("");
            const [unlockPass, setUnlockPass] = useState('');
            const [loginRole, setLoginRole] = useState('employee');
            const [loginName, setLoginName] = useState('');
            const [loginPass, setLoginPass] = useState('');
            const [cameraActive, setCameraActive] = useState(false);
            const [camType, setCamType] = useState(null);
            const [summaryImage, setSummaryImage] = useState(null);

            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            // Cargar datos
            useEffect(() => {
                const saved = localStorage.getItem('biometrick_session');
                if (saved) {
                    const data = JSON.parse(saved);
                    setCurrentEmployee(data.employee);
                    setView(data.view);
                    setIsUnlocked(true);
                }
            }, []);

            const saveState = (emp, v) => {
                setCurrentEmployee(emp);
                localStorage.setItem('biometrick_session', JSON.stringify({ employee: emp, view: v }));
                localStorage.setItem(`emp_${emp.id}`, JSON.stringify(emp));
            };

            const parseTimeToMinutes = (t) => {
                if (!t) return null;
                let clean = t.toLowerCase().replace(/[^0-9ap:]/g, '');
                let hours = 0, minutes = 0;
                if (clean.includes(':')) {
                    const parts = clean.split(':');
                    hours = parseInt(parts[0]);
                    minutes = parseInt(parts[1].substring(0,2)) || 0;
                } else {
                    hours = parseInt(clean);
                }
                if (clean.includes('pm') && hours < 12) hours += 12;
                if (clean.includes('am') && hours === 12) hours = 0;
                return (hours * 60) + minutes;
            };

            const payroll = useMemo(() => {
                if (!currentEmployee) return null;
                let hrs = 0, bonus = 0, days = 0;
                DAYS_LIST.forEach(d => {
                    if (!currentEmployee.restDays?.[d]) {
                        const t = currentEmployee.weeklyTime?.[d] || { h: 0, m: 0 };
                        const dec = t.h + (t.m / 60);
                        if (dec > 0) { 
                            days++; hrs += dec; 
                            if (Math.abs(dec - 9) < 0.1) bonus += currentEmployee.foodBonus; 
                        }
                    }
                });
                const base = hrs * currentEmployee.hourlyRate;
                const avg = days > 0 ? hrs / days : 0;
                const rest = (avg * currentEmployee.hourlyRate);
                return { total: base + bonus + rest + currentEmployee.stimulus, hrs, bonus, rest, days, base };
            }, [currentEmployee]);

            const handleLogin = () => {
                if (loginRole === 'boss') {
                    if (loginPass === "jefe123") setView('admin');
                    else alert("Clave de jefe incorrecta");
                    return;
                }
                const id = loginName.trim().toLowerCase().replace(/\s/g, '_');
                if (!id) return;
                const existing = localStorage.getItem(`emp_${id}`);
                let emp = existing ? JSON.parse(existing) : {
                    id, name: loginName, password: loginPass, hourlyRate: 100, stimulus: 250, foodBonus: 50,
                    weeklyTime: {}, restDays: {}, attendance: {}
                };
                if (existing && emp.password !== loginPass) { alert("Clave incorrecta"); return; }
                saveState(emp, 'app');
                setView('app');
            };

            const updateField = (day, type, val) => {
                const emp = { ...currentEmployee };
                if (!emp.attendance[day]) emp.attendance[day] = {};
                emp.attendance[day][type] = { ...emp.attendance[day][type], time: val };

                const ent = emp.attendance[day].entry?.time;
                const ext = emp.attendance[day].exit?.time;
                const mEnt = parseTimeToMinutes(ent);
                const mExt = parseTimeToMinutes(ext);

                if (mEnt !== null && mExt !== null) {
                    let diff = mExt - mEnt; if (diff < 0) diff += 1440;
                    emp.weeklyTime[day] = { h: Math.floor(diff/60), m: diff % 60 };
                }
                saveState(emp, 'app');
            };

            const startCamera = (type) => {
                setCamType(type); setCameraActive(true);
                setTimeout(() => {
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
                        .then(s => { if (videoRef.current) videoRef.current.srcObject = s; })
                        .catch(() => alert("Error: Usa HTTPS para usar la cámara."));
                }, 300);
            };

            const capture = () => {
                const canvas = canvasRef.current;
                const video = videoRef.current;
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const day = DAYS_LIST[(new Date().getDay() + 6) % 7];
                const photo = canvas.toDataURL('image/jpeg', 0.5);

                const emp = { ...currentEmployee };
                if (!emp.attendance[day]) emp.attendance[day] = {};
                emp.attendance[day][camType] = { photo, time: timeStr, timestamp: Date.now() };
                setCurrentEmployee(emp);
                updateField(day, camType, timeStr);
                
                if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
                setCameraActive(false);
                setAiMessage("¡Guardado!"); setTimeout(() => setAiMessage(""), 2000);
            };

            const generateTicket = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = 500; canvas.height = 1200; // SUPER LARGO para que no se corte
                
                ctx.fillStyle = '#0f172a'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#4f46e5'; ctx.fillRect(0, 0, canvas.width, 160);
                
                ctx.fillStyle = 'white';
                ctx.font = '900 36px sans-serif'; ctx.fillText('RECIBO DE NÓMINA', 40, 80);
                ctx.font = 'bold 18px sans-serif'; ctx.fillText(new Date().toLocaleDateString().toUpperCase(), 40, 120);
                
                ctx.font = '900 30px sans-serif'; ctx.fillText(currentEmployee.name.toUpperCase(), 40, 240);
                
                let y = 340;
                DAYS_LIST.forEach(d => {
                    const t = currentEmployee.weeklyTime?.[d] || { h: 0, m: 0 };
                    const isRest = currentEmployee.restDays?.[d];
                    ctx.fillStyle = isRest ? '#818cf8' : 'white';
                    ctx.font = '18px sans-serif';
                    ctx.fillText(d, 40, y);
                    ctx.textAlign = 'right';
                    ctx.fillText(isRest ? 'DÍA DE DESCANSO' : `${t.h}h ${t.m}m`, 460, y);
                    ctx.textAlign = 'left';
                    y += 60;
                });

                ctx.fillStyle = '#1e293b'; ctx.fillRect(20, y + 40, 460, 200);
                ctx.fillStyle = 'white'; ctx.font = 'bold 16px sans-serif';
                ctx.fillText('SUELDO NETO:', 40, y + 90);
                ctx.font = '900 50px sans-serif';
                ctx.fillText(`$${payroll.total.toFixed(2)}`, 40, y + 160);
                
                setSummaryImage(canvas.toDataURL('image/png'));
            };

            if (!isUnlocked) return (
                <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-8 text-white">
                    <div className="bg-indigo-600/20 p-6 rounded-full mb-8"><Icon name="fingerprint" className="w-16 h-16 text-indigo-500" /></div>
                    <h1 className="text-3xl font-black mb-10 tracking-tighter">BIOMETRICK v4.2</h1>
                    <input type="password" placeholder="Clave App" value={unlockPass} onChange={e => setUnlockPass(e.target.value)} className="w-full max-w-xs bg-slate-900 border border-slate-800 p-6 rounded-3xl text-center mb-6 outline-none focus:ring-2 ring-indigo-500" />
                    <button onClick={() => unlockPass === "acceso2025" ? setIsUnlocked(true) : alert("No")} className="w-full max-w-xs bg-indigo-600 py-6 rounded-3xl font-black uppercase tracking-widest shadow-xl">Desbloquear</button>
                </div>
            );

            if (view === 'login') return (
                <div className="min-h-screen bg-white flex flex-col p-8 justify-center items-center text-slate-900">
                    <Icon name="calculator" className="w-16 h-16 mb-10 text-indigo-600" />
                    <div className="flex bg-slate-100 p-1.5 rounded-2xl mb-8 w-full max-w-xs">
                        <button onClick={() => setLoginRole('employee')} className={`flex-1 py-3 rounded-xl font-black text-[10px] ${loginRole === 'employee' ? 'bg-white shadow text-indigo-600' : 'text-slate-400'}`}>EMPLEADO</button>
                        <button onClick={() => setLoginRole('boss')} className={`flex-1 py-3 rounded-xl font-black text-[10px] ${loginRole === 'boss' ? 'bg-white shadow text-indigo-600' : 'text-slate-400'}`}>JEFE</button>
                    </div>
                    <div className="space-y-4 w-full max-w-xs">
                        {loginRole === 'employee' && <input type="text" placeholder="Usuario" value={loginName} onChange={e => setLoginName(e.target.value)} className="w-full p-5 bg-slate-50 border rounded-3xl font-bold outline-none" />}
                        <input type="password" placeholder="Contraseña" value={loginPass} onChange={e => setLoginPass(e.target.value)} className="w-full p-5 bg-slate-50 border rounded-3xl font-bold outline-none" />
                        <button onClick={handleLogin} className="w-full bg-slate-900 text-white py-6 rounded-3xl font-black uppercase text-xs shadow-2xl active:scale-95 transition-all">Ingresar</button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col max-w-md mx-auto shadow-2xl relative text-slate-900 pb-32">
                    <canvas ref={canvasRef} className="hidden" />
                    {aiMessage && <div className="fixed top-10 left-10 right-10 z-[100] bg-emerald-600 text-white p-4 rounded-2xl shadow-2xl text-center font-black animate-bounce uppercase text-xs">{aiMessage}</div>}
                    
                    <header className="bg-white p-6 border-b flex justify-between items-center sticky top-0 z-40">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-black">{currentEmployee?.name[0].toUpperCase()}</div>
                            <h3 className="font-black text-xs uppercase">{currentEmployee?.name}</h3>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={generateTicket} className="p-3 bg-indigo-50 text-indigo-600 rounded-2xl active:scale-90"><Icon name="share-2" /></button>
                            <button onClick={() => { localStorage.removeItem('biometrick_session'); window.location.reload(); }} className="p-3 bg-slate-50 text-rose-500 rounded-2xl"><Icon name="log-out" /></button>
                        </div>
                    </header>

                    <main className="flex-1 p-6 space-y-6 overflow-y-auto custom-scrollbar">
                        {activeTab === 'home' ? (
                            <div className="space-y-6">
                                <div className="bg-slate-900 p-8 rounded-[3rem] text-white shadow-2xl relative overflow-hidden">
                                    <div className="absolute top-0 right-0 -mr-12 -mt-12 w-48 h-48 bg-indigo-500 rounded-full blur-[80px] opacity-20"></div>
                                    <p className="text-[8px] font-black uppercase text-slate-500 mb-2 tracking-widest">Sueldo Estimado</p>
                                    <h2 className="text-5xl font-black tracking-tighter mb-8 tabular-nums">${payroll?.total.toFixed(2)}</h2>
                                    <div className="grid grid-cols-2 gap-3 text-center">
                                        <div className="bg-white/5 p-4 rounded-2xl border border-white/5 backdrop-blur-md"><p className="text-[7px] font-black uppercase text-slate-500 mb-1">Horas</p><p className="font-black text-lg">{payroll?.hrs.toFixed(1)}h</p></div>
                                        <div className="bg-white/5 p-4 rounded-2xl border border-white/5 backdrop-blur-md"><p className="text-[7px] font-black uppercase text-slate-500 mb-1">Días</p><p className="font-black text-lg text-emerald-400">{payroll?.days}/7</p></div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => startCamera('entry')} className="bg-white p-6 rounded-[2.5rem] border shadow-sm flex flex-col items-center gap-3 active:scale-95 transition-all">
                                        <div className="w-12 h-12 bg-emerald-100 rounded-2xl flex items-center justify-center text-emerald-600"><Icon name="arrow-down-circle" /></div>
                                        <span className="font-black text-[9px] uppercase">Entrada</span>
                                    </button>
                                    <button onClick={() => startCamera('exit')} className="bg-white p-6 rounded-[2.5rem] border shadow-sm flex flex-col items-center gap-3 active:scale-95 transition-all">
                                        <div className="w-12 h-12 bg-rose-100 rounded-2xl flex items-center justify-center text-rose-600"><Icon name="arrow-up-circle" /></div>
                                        <span className="font-black text-[9px] uppercase">Salida</span>
                                    </button>
                                </div>

                                <div className="bg-white rounded-[2.5rem] p-6 border shadow-sm space-y-6">
                                    <h4 className="font-black text-[9px] uppercase text-slate-400 tracking-widest flex items-center gap-2"><Icon name="edit-3" className="w-3 h-3" /> Registro de Semana</h4>
                                    {DAYS_LIST.map(d => {
                                        const t = currentEmployee?.weeklyTime?.[d] || { h: 0, m: 0 };
                                        const isRest = currentEmployee?.restDays?.[d];
                                        const att = currentEmployee?.attendance?.[d] || {};
                                        return (
                                            <div key={d} className={`p-5 rounded-3xl border transition-all ${isRest ? 'bg-indigo-50 border-indigo-100 opacity-80' : 'bg-slate-50 border-slate-100'}`}>
                                                <div className="flex justify-between items-center mb-4">
                                                    <span className="font-black text-[11px] uppercase tracking-widest">{d}</span>
                                                    <button onClick={() => {
                                                        const emp = { ...currentEmployee };
                                                        emp.restDays[d] = !emp.restDays[d];
                                                        saveState(emp, 'app');
                                                    }} className={`px-4 py-2 rounded-xl text-[8px] font-black uppercase transition-all ${isRest ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white border text-slate-400'}`}>{isRest ? 'Descanso' : 'Marcar Descanso'}</button>
                                                </div>
                                                {!isRest && (
                                                    <div className="space-y-4">
                                                        <div className="grid grid-cols-2 gap-4">
                                                            <input type="text" value={att.entry?.time || ''} placeholder="Entrada" onChange={(e) => updateField(d, 'entry', e.target.value)} className="p-3 bg-white border rounded-xl text-center font-black text-emerald-600 text-xs outline-none focus:border-indigo-500" />
                                                            <input type="text" value={att.exit?.time || ''} placeholder="Salida" onChange={(e) => updateField(d, 'exit', e.target.value)} className="p-3 bg-white border rounded-xl text-center font-black text-rose-600 text-xs outline-none focus:border-indigo-500" />
                                                        </div>
                                                        <div className="flex gap-2">
                                                            {att.entry?.photo && <img src={att.entry.photo} className="w-1/2 aspect-video rounded-xl object-cover border" />}
                                                            {att.exit?.photo && <img src={att.exit.photo} className="w-1/2 aspect-video rounded-xl object-cover border" />}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-6">
                                <h2 className="text-3xl font-black uppercase tracking-tighter">Ajustes</h2>
                                <div className="bg-indigo-600 p-8 rounded-[3rem] text-white shadow-2xl space-y-8">
                                    <div><p className="text-[9px] font-black uppercase opacity-60 mb-2">Pago por Hora ($)</p>
                                        <input type="number" value={currentEmployee?.hourlyRate || 0} onChange={(e) => { const emp = { ...currentEmployee, hourlyRate: Number(e.target.value) }; saveState(emp, 'app'); }} className="w-full bg-white/10 rounded-2xl p-5 text-4xl font-black outline-none focus:bg-white/20 transition-all" />
                                    </div>
                                    <div><p className="text-[9px] font-black uppercase opacity-60 mb-2">Estímulo Semanal ($)</p>
                                        <input type="number" value={currentEmployee?.stimulus || 0} onChange={(e) => { const emp = { ...currentEmployee, stimulus: Number(e.target.value) }; saveState(emp, 'app'); }} className="w-full bg-white/10 rounded-2xl p-5 text-4xl font-black outline-none focus:bg-white/20 transition-all" />
                                    </div>
                                </div>
                                <div className="p-6 bg-white rounded-3xl border text-center font-bold text-[10px] text-slate-400 uppercase">Versión Local 4.2 - Los datos no salen de este celular.</div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t p-6 flex justify-around items-center z-50 rounded-t-[3rem] shadow-2xl max-w-md mx-auto">
                        <button onClick={() => setActiveTab('home')} className={`transition-all ${activeTab === 'home' ? 'text-indigo-600 scale-125' : 'text-slate-300'}`}><Icon name="home" /></button>
                        <button onClick={() => startCamera('entry')} className="bg-slate-900 p-5 rounded-full text-white -mt-16 border-8 border-slate-50 shadow-2xl active:scale-90 transition-all"><Icon name="camera" /></button>
                        <button onClick={() => setActiveTab('settings')} className={`transition-all ${activeTab === 'settings' ? 'text-indigo-600 scale-125' : 'text-slate-300'}`}><Icon name="user" /></button>
                    </nav>

                    {summaryImage && (
                        <div className="fixed inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center p-6 animate-in fade-in">
                            <div className="bg-white rounded-[3rem] overflow-hidden w-full max-w-sm flex flex-col shadow-2xl">
                                <div className="p-6 bg-slate-900 text-white flex justify-between items-center"><h3 className="font-black uppercase text-xs">Recibo Semanal</h3><button onClick={() => setSummaryImage(null)}><Icon name="x" /></button></div>
                                <div className="p-4 bg-slate-200 overflow-y-auto max-h-[70vh] custom-scrollbar flex items-center justify-center"><img src={summaryImage} className="w-full rounded-2xl shadow-xl border-4 border-white" /></div>
                                <div className="p-8 bg-white"><button onClick={() => { const a = document.createElement('a'); a.href = summaryImage; a.download = 'Recibo.png'; a.click(); }} className="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black uppercase text-xs shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2"><Icon name="download" className="w-4 h-4" /> Guardar Imagen</button></div>
                            </div>
                        </div>
                    )}

                    {cameraActive && (
                        <div className="fixed inset-0 z-[100] bg-black flex flex-col max-w-md mx-auto">
                            <div className="p-10 flex justify-between items-center text-white"><h3 className="font-black uppercase tracking-widest">Identificación</h3><button onClick={() => { if (videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t => t.stop()); setCameraActive(false); }} className="p-4 bg-white/10 rounded-2xl"><Icon name="x" /></button></div>
                            <div className="flex-1 relative bg-slate-950 flex items-center justify-center"><video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover" /><div className="absolute inset-0 border-[50px] border-black/60 rounded-[4rem] pointer-events-none"></div></div>
                            <div className="p-16 flex justify-center bg-black"><button onClick={capture} className="w-24 h-24 bg-white rounded-full border-[10px] border-indigo-600 flex items-center justify-center shadow-2xl shadow-indigo-500/50 active:scale-90 transition-all"><Icon name="camera" className="w-10 h-10 text-slate-900" /></button></div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>